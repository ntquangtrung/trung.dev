name: Test SSH Connection via Tailscale

on:
  workflow_call:  # Allow this workflow to be called by other workflows
  workflow_dispatch:  # Manual trigger only

permissions:
  contents: read

jobs:
  tailscale-connection:
    name: Test Connection to Ubuntu Server
    runs-on: ubuntu-latest
    environment: production

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Tailscale and SSH
      uses: ./.github/actions/setup-tailscale-ssh
      with:
        oauth-client-id: ${{ secrets.TS_OAUTH_CLIENT_ID }}
        oauth-secret: ${{ secrets.TS_OAUTH_SECRET }}
        ssh-private-key: ${{ secrets.SERVER_SSH_KEY }}
        server-host: ${{ secrets.SERVER_HOST }}
        server-user: ${{ secrets.SERVER_USER }}
        skip-ping: 'false'

    - name: Test SSH Connection
      env:
        SERVER_USER: ${{ secrets.SERVER_USER }}
        SERVER_HOST: ${{ secrets.SERVER_HOST }}
      run: |
        echo "================================================"
        echo "Testing SSH connection to $SERVER_HOST..."
        echo "================================================"
        ssh -o StrictHostKeyChecking=no $SERVER_USER@$SERVER_HOST << 'EOF'
          set -e
          echo ""
          echo "✅ SSH Connection Successful!"
          echo "================================================"
          echo "Server Information:"
          echo "  Hostname: $(hostname)"
          echo "  User: $(whoami)"
          echo "  OS: $(cat /etc/os-release | grep PRETTY_NAME | cut -d'"' -f2)"
          echo "  Kernel: $(uname -r)"
          echo "  Uptime: $(uptime -p)"
          echo ""
          echo "Docker Information:"
          if command -v docker >/dev/null 2>&1; then
            echo "  Docker: ✅ Installed"
            echo "  Version: $(docker --version)"
            echo "  Docker Running: $(systemctl is-active docker || echo 'N/A')"
          else
            echo "  Docker: ❌ Not Installed"
          fi
          echo ""
          if command -v docker compose >/dev/null 2>&1; then
            echo "  Docker Compose: ✅ Installed"
            echo "  Version: $(docker compose version)"
          else
            echo "  Docker Compose: ❌ Not Installed"
          fi
          echo ""
          echo "Disk Space:"
          df -h / | tail -1 | awk '{print "  Root: "$3" used / "$2" total ("$5" used)"}'
          echo ""
          echo "Memory:"
          free -h | grep Mem | awk '{print "  Total: "$2" | Used: "$3" | Free: "$4}'
          echo "================================================"
        EOF
        echo ""
        echo "✅ Connection test completed successfully!"
