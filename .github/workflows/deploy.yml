name: Manual Deploy to Ubuntu Server

on:
  workflow_call:  # Allow this workflow to be called by other workflows
  workflow_dispatch:  # Manual trigger only

permissions:
  contents: read

jobs:
  deploy:
    name: Deploy to Ubuntu Server
    runs-on: ubuntu-latest
    environment: production

    steps:
    - name: Checkout Repo
      uses: actions/checkout@v4

    - name: Setup Tailscale and SSH
      uses: ./.github/actions/setup-tailscale-ssh
      with:
        oauth-client-id: ${{ secrets.TS_OAUTH_CLIENT_ID }}
        oauth-secret: ${{ secrets.TS_OAUTH_SECRET }}
        ssh-private-key: ${{ secrets.SERVER_SSH_KEY }}
        server-host: ${{ secrets.SERVER_HOST }}
        server-user: ${{ secrets.SERVER_USER }}
        skip-ping: 'true'

    - name: Deploy via SSH
      env:
        SERVER_USER: ${{ secrets.SERVER_USER }}  # e.g., 'ubuntu' or your username
        SERVER_HOST: ${{ secrets.SERVER_HOST }}  # Tailscale hostname or IP (e.g., 100.x.x.x)
        DEPLOY_PATH: ${{ vars.DEPLOY_PATH }}  # e.g., '/home/ubuntu/django-app'
        REPO_URL: https://${{ secrets.DEPLOY_PAT_TOKEN }}@github.com/${{ github.repository }}.git
        BRANCH: ${{ github.ref_name }}
        POSTGRES_USER: ${{ secrets.POSTGRES_USER }}
        POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
        POSTGRES_HOST: ${{ secrets.POSTGRES_HOST }}
        POSTGRES_PORT: ${{ secrets.POSTGRES_PORT }}
        POSTGRES_DB: ${{ secrets.POSTGRES_DB }}
        ENVIRONMENT: ${{ vars.ENVIRONMENT }}
        DJANGO_SETTINGS_MODULE: config.settings.${{ vars.ENVIRONMENT }}
        DJANGO_ALLOWED_HOSTS: ${{ vars.DJANGO_ALLOWED_HOSTS }}
        DJANGO_CSRF_TRUSTED_ORIGINS: ${{ vars.DJANGO_CSRF_TRUSTED_ORIGINS }}
        DJANGO_SECRET_KEY: ${{ secrets.DJANGO_SECRET_KEY }}
        CLIENT_GITHUB_TOKEN: ${{ secrets.CLIENT_GITHUB_TOKEN }}
        CLIENT_GITHUB_BASE_URL: ${{ secrets.CLIENT_GITHUB_BASE_URL }}
        CLIENT_GITHUB_API_VERSION: ${{ secrets.CLIENT_GITHUB_API_VERSION }}
        REDIS_PASSWORD: ${{ secrets.REDIS_PASSWORD }}
        REDIS_HOST: ${{ vars.REDIS_HOST }}
        REDIS_PORT: ${{ vars.REDIS_PORT }}
        REDIS_DB_INDEX: ${{ vars.REDIS_DB_INDEX }}
        CELERY_BROKER_REDIS_DB_INDEX: ${{ vars.CELERY_BROKER_REDIS_DB_INDEX }}
        CELERY_BACKEND_REDIS_DB_INDEX: ${{ vars.CELERY_BACKEND_REDIS_DB_INDEX }}
        FLOWER_USER: ${{ vars.FLOWER_USER }}
        FLOWER_PASSWORD: ${{ secrets.FLOWER_PASSWORD }}
      run: |
        ssh -o StrictHostKeyChecking=no $SERVER_USER@$SERVER_HOST << EOF
          set -e
          # Check if parent directory exists------------------
          EXPANDED_DEPLOY_PATH=$(eval echo "$DEPLOY_PATH")
          PARENT_DIR=$(dirname "$EXPANDED_DEPLOY_PATH")
          if [ ! -d "$PARENT_DIR" ]; then
            echo "âŒ Error: Parent directory '$PARENT_DIR' does not exist on server"
            echo "Please create the parent directory first or update DEPLOY_PATH variable"
            exit 1
          fi
          exit 1
          # Clone or pull repo
          if [ ! -d "$EXPANDED_DEPLOY_PATH" ]; then
            echo "ðŸ“¦ Cloning repository to $EXPANDED_DEPLOY_PATH..."
            git clone "$REPO_URL" "$EXPANDED_DEPLOY_PATH"
          fi
          # Change to the app directory------------------
          cd $DEPLOY_PATH
          git pull --rebase origin $BRANCH
          # Write environment variables------------------
          cat <<EOT > .env
          POSTGRES_DB=$POSTGRES_DB
          POSTGRES_USER=$POSTGRES_USER
          POSTGRES_PASSWORD=$POSTGRES_PASSWORD
          POSTGRES_HOST=$POSTGRES_HOST
          POSTGRES_PORT=$POSTGRES_PORT
          ENVIRONMENT=$ENVIRONMENT
          DJANGO_SETTINGS_MODULE=$DJANGO_SETTINGS_MODULE
          DJANGO_ALLOWED_HOSTS=$DJANGO_ALLOWED_HOSTS
          DJANGO_CSRF_TRUSTED_ORIGINS=$DJANGO_CSRF_TRUSTED_ORIGINS
          DJANGO_SECRET_KEY="$DJANGO_SECRET_KEY"
          CLIENT_GITHUB_TOKEN=$CLIENT_GITHUB_TOKEN
          CLIENT_GITHUB_BASE_URL=$CLIENT_GITHUB_BASE_URL
          CLIENT_GITHUB_API_VERSION=$CLIENT_GITHUB_API_VERSION
          REDIS_PASSWORD=$REDIS_PASSWORD
          REDIS_HOST=$REDIS_HOST
          REDIS_PORT=$REDIS_PORT
          REDIS_DB_INDEX=$REDIS_DB_INDEX
          CELERY_BROKER_REDIS_DB_INDEX=$CELERY_BROKER_REDIS_DB_INDEX
          CELERY_BACKEND_REDIS_DB_INDEX=$CELERY_BACKEND_REDIS_DB_INDEX
          FLOWER_USER=$FLOWER_USER
          FLOWER_PASSWORD=$FLOWER_PASSWORD
        EOT
          # Run Docker Compose------------------
          docker compose down --remove-orphans
          docker compose -f docker-compose.yml -f docker-compose.prod.yml up --build -d
          docker image prune -f --filter "dangling=true" # Clean up dangling images
        EOF
