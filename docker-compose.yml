name: simple-django-blog

# Shared app configuration: build + runtime environment
# Secrets are passed at container runtime, not baked into the image
x-app: &default-app
  build:
    context: .
  volumes:
    - .:/app
    - static_volume:/app/staticfiles
  environment:
    # Django
    - ENVIRONMENT=${ENVIRONMENT}
    - DJANGO_SECRET_KEY=${DJANGO_SECRET_KEY}
    - DJANGO_SETTINGS_MODULE=${DJANGO_SETTINGS_MODULE}
    - DJANGO_ALLOWED_HOSTS=${DJANGO_ALLOWED_HOSTS}
    - DJANGO_CSRF_TRUSTED_ORIGINS=${DJANGO_CSRF_TRUSTED_ORIGINS}
    - DJANGO_INTERNAL_IPS=${DJANGO_INTERNAL_IPS}
    # GitHub client
    - CLIENT_GITHUB_TOKEN=${CLIENT_GITHUB_TOKEN}
    - CLIENT_GITHUB_BASE_URL=${CLIENT_GITHUB_BASE_URL}
    - CLIENT_GITHUB_API_VERSION=${CLIENT_GITHUB_API_VERSION}
    # Redis
    - REDIS_PASSWORD=${REDIS_PASSWORD}
    - REDIS_HOST=${REDIS_HOST}
    - REDIS_PORT=${REDIS_PORT}
    - REDIS_DB_INDEX=${REDIS_DB_INDEX}
    # Celery
    - CELERY_BROKER_REDIS_DB_INDEX=${CELERY_BROKER_REDIS_DB_INDEX}
    - CELERY_BACKEND_REDIS_DB_INDEX=${CELERY_BACKEND_REDIS_DB_INDEX}
    # Flower
    - FLOWER_USER=${FLOWER_USER}
    - FLOWER_PASSWORD=${FLOWER_PASSWORD}
    # Storage
    - SEAWEEDFS_URL=${SEAWEEDFS_URL}
    # Database
    - POSTGRES_DB=${POSTGRES_DB}
    - POSTGRES_USER=${POSTGRES_USER}
    - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
    - POSTGRES_HOST=${POSTGRES_HOST}
    - POSTGRES_PORT=${POSTGRES_PORT}

services:
  django:
    <<: *default-app
    image: django-blog-image
    container_name: django-blog-container
    command: /usr/local/bin/entrypoint.sh
    ports:
      - "8000:8000"

  tailwind:
    <<: *default-app
    image: django-blog-image
    container_name: django-tailwind-container
    command: >
      sh -c 'if [ "$ENVIRONMENT" = "production" ]; then
        echo "Starting Tailwind in production mode";
        poetry run python manage.py tailwind build;
      else
        echo "Starting Tailwind in development mode";
        poetry run python manage.py tailwind start;
      fi'
    tty: true

  redis:
    image: redis:alpine
    container_name: django-redis-container
    ports:
      - "6379:6379"
    command: redis-server --save "" --appendonly no --requirepass ${REDIS_PASSWORD}
    environment:
      - REDIS_PASSWORD=${REDIS_PASSWORD}
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "${REDIS_PASSWORD}", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3

  celery-worker:
    <<: *default-app
    image: django-blog-image
    container_name: django-celery-worker-container
    command: >
      sh -c 'poetry run celery -A config worker --loglevel=info'
    depends_on:
      - redis
      - django

  celery-beat:
    <<: *default-app
    image: django-blog-image
    container_name: django-celery-beat-container
    command: >
      sh -c 'poetry run celery -A config beat --loglevel=info --scheduler django_celery_beat.schedulers:DatabaseScheduler'
    depends_on:
      - redis
      - django
    volumes:
      - .:/app

  flower:
    <<: *default-app
    image: django-blog-image
    container_name: django-flower-container
    command: >
      poetry run celery -A config.celery flower --port=5555 --basic_auth=${FLOWER_USER}:${FLOWER_PASSWORD} --broker=redis://:${REDIS_PASSWORD}@redis:${REDIS_PORT}/${CELERY_BROKER_REDIS_DB_INDEX} --result-backend=redis://:${REDIS_PASSWORD}@redis:${REDIS_PORT}/${CELERY_BACKEND_REDIS_DB_INDEX}
    ports:
      - "5555:5555"
    depends_on:
      - redis
      - django
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5555/"]
      interval: 30s
      timeout: 10s
      retries: 3

  discord-bot:
    <<: *default-app
    image: django-blog-image
    container_name: django-discord-bot-container
    command: >
      sh -c 'poetry run python services/discord/bot.py'
    depends_on:
      - django
    environment:
      - DISCORD_BOT_TOKEN=${DISCORD_BOT_TOKEN}

volumes:
  static_volume:
  redis_data:
