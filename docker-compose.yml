name: simple-django-blog

x-app: &default-app
  build:
    context: .
    # We are not using env_file here because Dockerfile build args do not receive values from env_file; instead, we must pass environment variables directly via args in the docker-compose file.
    args:
      - DEBUG=${DEBUG}
      - DJANGO_SETTINGS_MODULE=${DJANGO_SETTINGS_MODULE}

      - DJANGO_ALLOWED_HOSTS=${DJANGO_ALLOWED_HOSTS}
      - DJANGO_CSRF_TRUSTED_ORIGINS=${DJANGO_CSRF_TRUSTED_ORIGINS}
      - DJANGO_INTERNAL_IPS=${DJANGO_INTERNAL_IPS}

      - GITHUB_PERSONAL_ACCESS_TOKEN=${GITHUB_PERSONAL_ACCESS_TOKEN}
      - GITHUB_BASE_URL=${GITHUB_BASE_URL}
      - GITHUB_API_VERSION=${GITHUB_API_VERSION}

      - REDIS_PASSWORD=${REDIS_PASSWORD}
      - REDIS_HOST=${REDIS_HOST}
      - REDIS_PORT=${REDIS_PORT}
      - REDIS_DB_INDEX=${REDIS_DB_INDEX}

      - CELERY_BROKER_REDIS_DB_INDEX=${CELERY_BROKER_REDIS_DB_INDEX}
      - CELERY_BACKEND_REDIS_DB_INDEX=${CELERY_BACKEND_REDIS_DB_INDEX}

      - FLOWER_USER=${FLOWER_USER}
      - FLOWER_PASSWORD=${FLOWER_PASSWORD}

      - SEAWEEDFS_URL=${SEAWEEDFS_URL}

  volumes:
    - .:/app
    - static_volume:/app/staticfiles

services:
  django:
    <<: *default-app
    image: django-blog-image
    container_name: django-blog-container
    command: /usr/local/bin/entrypoint.sh
    ports:
      - "8000:8000"
    networks:
      - seaweed_network

  tailwind:
    <<: *default-app
    image: django-blog-image
    container_name: django-tailwind-container
    command: >
      sh -c 'if [ "$DEBUG" = "True" ]; then
        echo "Starting Tailwind in development mode";
        poetry run python manage.py tailwind start;
      else
        echo "Starting Tailwind in production mode";
        poetry run python manage.py tailwind build;
      fi'
    tty: true

  redis:
    image: redis:alpine
    container_name: django-redis-container
    ports:
      - "6379:6379"
    command: redis-server --save "" --appendonly no --requirepass ${REDIS_PASSWORD}
    environment:
      - REDIS_PASSWORD=${REDIS_PASSWORD}
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "${REDIS_PASSWORD}", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3

  celery-worker:
    image: django-blog-image
    container_name: django-celery-worker-container
    command: >
      sh -c 'poetry run celery -A config worker --loglevel=info'
    depends_on:
      - redis
      - django
    environment:
      - CELERY_BROKER_URL=redis://:${REDIS_PASSWORD}@redis:${REDIS_PORT}/${CELERY_BROKER_REDIS_DB_INDEX}
      - CELERY_RESULT_BACKEND=redis://:${REDIS_PASSWORD}@redis:${REDIS_PORT}/${CELERY_BACKEND_REDIS_DB_INDEX}

  celery-beat:
    image: django-blog-image
    container_name: django-celery-beat-container
    command: >
      sh -c 'poetry run celery -A config beat --loglevel=info --scheduler django_celery_beat.schedulers:DatabaseScheduler'
    depends_on:
      - redis
      - django
    volumes:
      - .:/app

  flower:
    image: django-blog-image
    container_name: django-flower-container
    command: >
      poetry run celery -A config.celery flower --port=5555 --basic_auth=${FLOWER_USER}:${FLOWER_PASSWORD} --broker=redis://:${REDIS_PASSWORD}@redis:${REDIS_PORT}/${CELERY_BROKER_REDIS_DB_INDEX} --result-backend=redis://:${REDIS_PASSWORD}@redis:${REDIS_PORT}/${CELERY_BACKEND_REDIS_DB_INDEX}
    ports:
      - "5555:5555"
    environment:
      - REDIS_PASSWORD=${REDIS_PASSWORD}
      - REDIS_HOST=${REDIS_HOST}
    depends_on:
      - redis
      - django
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5555/"]
      interval: 30s
      timeout: 10s
      retries: 3

  discord-bot:
    image: django-blog-image
    container_name: django-discord-bot-container
    command: >
      sh -c 'poetry run python services/discord/bot.py'
    depends_on:
      - django
    environment:
      - DISCORD_BOT_TOKEN=${DISCORD_BOT_TOKEN}

  seaweedfs-master:
    image: chrislusf/seaweedfs:latest
    container_name: seaweedfs-master
    command: master -ip=seaweedfs-master -port=9333 -mdir=/data
    ports:
      - "9333:9333"
    volumes:
      - seaweed_master_data:/data
    restart: unless-stopped
    networks:
      - seaweed_network

  seaweedfs-volume:
    image: chrislusf/seaweedfs:latest
    container_name: seaweedfs-volume
    command: volume -max=5 -mserver="seaweedfs-master:9333" -port=8080 -dir=/data
    expose:
      - "8080"
      - "18080"
    volumes:
      - seaweed_volume_data:/data
    depends_on:
      - seaweedfs-master
    restart: unless-stopped
    networks:
      - seaweed_network

  seaweedfs-filer:
    image: chrislusf/seaweedfs:latest
    container_name: seaweedfs-filer
    command: filer -master="seaweedfs-master:9333" -port=8888
    ports:
      - "8888:8888"    # Filer HTTP API
    volumes:
      - seaweed_filer_data:/data
    depends_on:
      - seaweedfs-master
      - seaweedfs-volume
    restart: unless-stopped
    networks:
      - seaweed_network

volumes:
  static_volume:
  redis_data:
  seaweed_master_data:
  seaweed_volume_data:
  seaweed_filer_data:

networks:
  seaweed_network:
    driver: bridge
